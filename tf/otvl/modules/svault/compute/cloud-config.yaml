#cloud-config
write_files:
  - content: |
      #!/bin/sh
      export CI_LHN=${tf_loc_hostname}
      export CI_LIP4=${tf_loc_ip_v4}
      export CI_DOT_REPO=${tf_dot_repo}
      export CI_DOT_BRANCH=${tf_dot_branch}
      export CI_GOV=${tf_go_version}
      export HOME=/root
      echo `date`: command $0 is starting
      apt-get update && \
      apt-get install -y --no-install-recommends git jq yq curl fail2ban python3-systemd && \
      mkdir -p /root/clinit /root/locgit && cd /root/locgit && \
      curl -L https://go.dev/dl/go$CI_GOV.linux-amd64.tar.gz -o go.tgz && \
      rm -rf /usr/local/go && tar -C /usr/local -xzf go.tgz && rm go.tgz && \
      git clone --single-branch --branch $CI_DOT_BRANCH $CI_DOT_REPO && \
      cd otvl_devops_tools/src/go/bssms/ && /usr/local/go/bin/go build -o /usr/local/bin ./... && \
      cd  /root/clinit && rm -rf otvl_devops_tools && rm -rf /usr/local/go && \
      systemctl daemon-reload && \
      systemctl enable bssms_proxy && \
      systemctl start bssms_proxy && \
      true || exit 1
      echo `date`: command $0 is exiting
      exit 0
    path: /root/bin/otvl_cloud_init.sh
    owner: root:root
    permissions: '0750'
  - content: |
      [Unit]
      Description=Runs bssms proxy
      [Service]
      ExecStart=/usr/local/bin/bssms px -la 0.0.0.0:${tf_bssms_proxy_port} --host `hostname` -ut
      WorkingDirectory=/root
      [Install]
      WantedBy=multi-user.target
    path: /etc/systemd/system/bssms_proxy.service
    permissions: '0644'
  - content: |
      [DEFAULT]
      # Debian 12 has no log files, just journalctl
      backend = systemd
      # "bantime" is the number of seconds that a host is banned.
      bantime  = 1d
      # "maxretry" is the number of failures before a host get banned.
      maxretry = 5
      # A host is banned if it has generated "maxretry" during the last "findtime"
      findtime  = 1h
      [sshd]
      enabled = true
    path: /etc/fail2ban/jail.local
    permissions: '0644'
runcmd:
  - [ /root/bin/otvl_cloud_init.sh ]
