---
# sk3s_server/tasks/main.yml

# FIXME: ip route add default via 91.134.11.1 dev ens3

- name: Create rancher/k3s configuration directory
  file:
    path: "/etc/rancher/k3s"
    state: directory
    mode: 0755

- name: Configure rancher/k3s TLS SAN in /etc/rancher/k3s/config.yaml
  template:
    src: rancher-config.yaml
    dest: /etc/rancher/k3s/config.yaml

- name: Create otvl/k3s configuration yaml directory
  file:
    path: "{{ cv.config_paths.data }}/otvl/k3s"
    state: directory
    mode: 0755

- name: Create k3s manifests directory
  file:
    path: /var/lib/rancher/k3s/server/manifests
    state: directory
    mode: 0755

- name: Configure traefik ingress controller /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
  template:
    src: traefik-config.yaml
    dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
  when: cv.k3s.traefik.customize

- name: Install the k3s cluster if absent
  shell: "curl -sfL https://get.k3s.io | sh -s - --token-file /root/.config/.otvl/.secrets/k3s_token {{ '--docker' if cv.k3s.docker | default(true) }}"
  args:
    creates: /etc/systemd/system/k3s.service
  register: k3s_svc_create
  # cat /var/lib/rancher/k3s/server/token

- name: Configure the k3s private registry /etc/rancher/k3s/registries.yaml
  template:
    src: registries.yaml
    dest: /etc/rancher/k3s/registries.yaml
  register: reg_del

- name: Restart the k3s.service once registries.yaml delivered
  systemd:
    name: k3s.service
    state: restarted
  when: reg_del.changed

- name: Make k3s cluster config copy readable
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    remote_src: true
    dest: "{{ cv.config_paths.data }}/otvl/k3s/k3s.yaml"
    mode: "0644"
  when: k3s_svc_create.changed or reg_del.changed

- name: Adapt k3s cluster config localhost to api_server in {{ cv.config_paths.data }}/otvl/k3s/k3s.yaml
  ansible.builtin.replace:
    path: "{{ cv.config_paths.data }}/otvl/k3s/k3s.yaml"
    regexp: "https://127.0.0.1:"
    replace: "https://{{ cv.k3s.sc_api_server }}:"

- name: Create kube config {{ remote_user_home }}/.kube
  file:
    path: "{{ remote_user_home }}/.kube"
    state: directory
    mode: 0700
  become: false

- name: Configure kube clients on k3s single node
  ansible.builtin.copy:
    src: "{{ cv.config_paths.data }}/otvl/k3s/k3s.yaml"
    remote_src: false
    dest: "{{ remote_user_home }}/.kube/config"
    mode: "0600"
  become: false

###