---
# services/images_builder/tasks/main.yml

- name: Write build ssh key
  ansible.builtin.copy:
    content: "{{ cv.build.ssh.pri }}"
    dest: /home/{{ ansible_env.USER }}/.ssh/id_ed_build
    mode: 0600

- name: Write container registry password
  ansible.builtin.copy:
    content: "{{ cv.ctr.password }}"
    dest: /home/{{ ansible_env.USER }}/.config/.otvl/.secrets/ctr_password
    mode: 0600

- name: Loop over repositories to synchronize
  include_tasks: synchronize_repository.yml
  loop:
  - otvl_dvoptls
  - otvl_blog
  - otvl_adq
  loop_control:
    loop_var: current_item

- name: Create secrets dir on build server
  block:
    - command:
        cmd: "ssh -i /home/{{ ansible_env.USER }}/.ssh/id_ed_build -o StrictHostKeyChecking=no {{ cv.build.ssh.user }}@{{ cv.build.vm }} mkdir -p .config/.otvl/.secrets"
      register: rccs
    - debug: var=rccs.cmd
    - debug: var=rccs.stderr_lines
    - debug: var=rccs.stdout_lines

- name: Synchronize secrets
  ansible.posix.synchronize:
    src: "/home/{{ ansible_env.USER }}/.config/.otvl/.secrets/ctr_password"
    dest: "{{ cv.build.ssh.user }}@{{ cv.build.vm }}:.config/.otvl/.secrets/ctr_password"
    private_key: "/home/{{ ansible_env.USER }}/.ssh/id_ed_build"

- name: Wait for DNS update for CTR FQDN
  block:
    - debug:
        msg: "python3 /home/{{ ansible_env.USER }}/locgit/otvl_dvoptls/pynsutil/wait_ns.py -l {{ ci_env.CI_LHN }}-ext -n {{ cv.ctr.ingress_host }}"
    - command:
        cmd: "python3 /home/{{ ansible_env.USER }}/locgit/otvl_dvoptls/pynsutil/wait_ns.py -l {{ ci_env.CI_LHN }}-ext -n {{ cv.ctr.ingress_host }}"
      register: wdns
    - debug: var=wdns.cmd
    - debug: var=wdns.stderr_lines
    - debug: var=wdns.stdout_lines

- name: Wait for letencrypt cert ready for CTR
  block:
    - debug:
        msg: "python3 /home/{{ ansible_env.USER }}/locgit/otvl_dvoptls/pynsutil/wait_cert.py -u https://{{ cv.ctr.ingress_host }}"
    - command:
        cmd: "python3 /home/{{ ansible_env.USER }}/locgit/otvl_dvoptls/pynsutil/wait_cert.py -u https://{{ cv.ctr.ingress_host }}"
      register: wctr
    - debug: var=wctr.cmd
    - debug: var=wctr.stderr_lines
    - debug: var=wctr.stdout_lines
  
- name: Loop over otvl_web sites to build
  include_tasks: run_otvl_web_build.yml
  loop: "{{ cv.otvl_web_services }}"
  loop_control:
    loop_var: current_item

- name: Build base image k8s-clients
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image k8s-clients"
    dkb_cmd_dir: "otvl_dvoptls/docker/k8s_clients"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.k8s_clients.image }}"

- name: Build base image for code-server
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image for code-server"
    dkb_cmd_dir: "otvl_dvoptls/docker/code_server"
    dkb_add_args: "--build-arg CSV={{ cv.code_server.build_arg }}"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.code_server.image }}"

- name: Build image for cs-kub-dk
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image for cs-kub-dk"
    dkb_cmd_dir: "otvl_dvoptls/docker/cs_kubdk"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_kubdk.image }}"

- name: Build base image for cs-ops
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image for cs-ops"
    dkb_cmd_dir: "otvl_dvoptls/docker/cs_ops"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_ops.image }}"

- name: Build base image for cs-python
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image for cs-python"
    dkb_cmd_dir: "otvl_dvoptls/docker/cs_python"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_python.image }}"

- name: Build base image for cs-pythonk
  include_role:
    name: commons
    tasks_from: rdocker_build
  vars:
    dkb_message: "Build base image for cs-pythonk"
    dkb_cmd_dir: "otvl_dvoptls/docker/cs_pythonk"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_pythonk.image }}"
