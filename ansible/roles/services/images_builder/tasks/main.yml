---
# services/images_builder/tasks/main.yml

- name: Write build ssh key
  ansible.builtin.copy:
    content: "{{ cv.build.ssh.pri }}"
    dest: /home/{{ ansible_env.USER }}/.ssh/id_ed_build
    mode: 0600
  become: false

- name: Synchronize repositories
  ansible.posix.synchronize:
    src: "/home/{{ ansible_env.USER }}/locgit/otvl_dvoptls/"
    dest: "{{ cv.build.ssh.user }}@{{ cv.build.vm }}:locgit/otvl_dvoptls/"
    private_key: "/home/{{ ansible_env.USER }}/.ssh/id_ed_build"
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=venv"
  become: false

- name: Build base image for code-server
  include_role:
    name: commons
    tasks_from: nerdctl_build
  vars:
    dkb_message: "Build base image for code-server"
    dkb_cmd_dir: "{{ playbook_dir }}/../docker/code_server"
    dkb_add_args: "--build-arg CSV=4.101.2"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.code_server.image }}"

- name: Build base image for cs-ops
  include_role:
    name: commons
    tasks_from: nerdctl_build
  vars:
    dkb_message: "Build base image for cs-ops"
    dkb_cmd_dir: "{{ playbook_dir }}/../docker/cs_ops"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_ops.image }}"

- name: Build base image for cs-python
  include_role:
    name: commons
    tasks_from: nerdctl_build
  vars:
    dkb_message: "Build base image for cs-python"
    dkb_cmd_dir: "{{ playbook_dir }}/../docker/cs_python"
    ctr_reg: "{{ cv.ctr.ingress_host }}"
    image: "{{ cv.cs_python.image }}"
