# commons/tasks/rdocker_build.yml
# ssh run docker build, tag and push to registry
# vars:
#   dkb_message: message to be displayed during docker build
#   dkb_cmd_dir: docker build command directory
#   dkb_arg_dir: docker build argument directory, defaults to "."
#   dkb_add_args: docker build additional arguments defaults to ""
#   docker_file: docker file defaults to Dockerfile in build directory
#   image: image name and version to tag and push
#

- name: set role's variables
  set_fact:
    dkb_ssh_pfx: "ssh -i /home/{{ ansible_env.USER }}/.ssh/id_ed_build -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ cv.build.ssh.user }}@{{ cv.build.vm }}"
    dkb_rdkb_path: "/home/{{ cv.build.ssh.user }}/locgit/otvl_dvoptls/install_scripts/docker_build_tag.sh"

- name: "{{ dkb_message }}"
  block:
    - command:
        cmd: "{{ dkb_ssh_pfx }} {{ dkb_rdkb_path }} {{ dkb_cmd_dir }} {{ dkb_arg_dir | default('.') }} {{ docker_file | default('Dockerfile') }} {{ image }} {{ cv.ctr.ingress_host }} {{ cv.ctr.login }} {{ dkb_add_args | default('') }}"
      register: dkb
      ignore_errors: true
    - debug: var=dkb.cmd
    - debug: var=dkb.stderr_lines
    - debug: var=dkb.stdout_lines
    - fail:
      when: dkb.rc != 0
